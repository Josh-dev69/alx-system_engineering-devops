#!/usr/bin/env bash
# Configuration of load balancer on the server

# Update package list and Install HAProxy
sudo apt -y update
sudo apt install -y haproxy

# Define configuration file path
CONFIG_FILE="/etc/haproxy/haproxy.cfg"

# Use sed to replace existing configuration
sudo sed -i -e '/^frontend localhost/,/^$/c\
frontend localhost\n    bind *:80\n    mode http\n    default_backend servers\
' "$CONFIG_FILE"

sudo sed -i -e '/^backend servers/,/^$/c\
backend servers\n    mode http\n    balance roundrobin\n    option httpclose\n    option forwardfor\n    server server1 219004-web-01 52.91.133.84:80 check\n    server server2 219004-web-02 52.3.244.11:80 check\
' "$CONFIG_FILE"

# Restart HAProxy
sudo service haproxy restart
